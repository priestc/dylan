{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="/static/album.css" type="text/css" media="all" />
{% endblock %}

{% block title %}{{ data.album.title }}{% endblock %}

{% block content %}
    <h1 id="album_title">{{ data.album.title }}</h1>
    <table id="album_data"><br><br>
        <tr>
            <th>Run time:</th>
            <td>{{ data.album.duration() }}<td>
            <th>Source:</th>
            <td>{{ data.album.source }}<td>
        </tr>
        <tr>
            <th>Date:</th>
            <td>{{ data.album.date }}<td>
            <th>Encoding:</th>
            <td>{{ data.album.encoding }}<td>
        </tr>
        <tr>
            <th>City:</th>
            <td><a href="/city/{{ data.album.city_slug }}">{{ data.album.city }}</a><td>
            <th>Performance:</th>
            <td>5.3/10<td>
        </tr>
        <tr>
            <th>Venue:</th>
            <td><a href="/venue/{{ data.album.venue_slug }}">{{ data.album.venue }}<td>
            <th>Sound:</th>
            <td>5.3/10<td>
        </tr>
    </table>
    <br>
    <div id="player_box">
        <div id="currently_playing"></div>
        <div id="player_container"><audio id="player" controls></audio></div>
    
        <table id="playlist_table">
            {% for song in data.album.songs %}
            <tr class="row_{{ song.track }}">
                <td class="links_column">
                    <a class="more_link" href="/song/{{ song.slug }}">more</a>
                </td>

                <td class="track_column">
                     {{ song.track }}
                </td>
                <td class="title_column">
                    <a href class="playlist_item" id="track_{{ song.track }}">{{ song.title }}</a>
                </td>
                <td class="duration_column">
                    <span class="hidden_info" id="info_{{ song.track }}">
                        <span class="title">{{ song.title }}</span>
                        <span class="duration">{{ song.duration }}</span>
                        <span class="slug">{{ song.slug }}</span>
                    </span>
                    {{ song.duration }}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>


    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'dylanshows'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

    <script>
        var urls = {{ data.album.playlist_urls_js() }};
        var player = $('#player');

        var initial_track = 1;
        if(window.location.hash.substr(1, 5) == 'track') {
            initial_track = Number(window.location.hash.substr(6));
        }

        function set_player(track) {
            // set the player to the track.
            player.attr('src', urls[track]);
            player.attr('track', track);
            set_currently_playing(track);
            player.trigger('change');
        }

        // set initial state
        set_player(initial_track);

        function set_currently_playing(track) {
            // set the title at the top of the player.
            var data = get_info(track);
            $('#currently_playing').text(data.song + ' [' + data.duration + ']');
            $('#playlist_table tr').removeClass('now_playing');
            $('#playlist_table tr.row_' + track).addClass('now_playing');
        }

        player.bind('ended', function() {
            var track = Number($(this).attr('track'));
            var new_track = track + 1;
            if (new_track >= urls.length) {
                return
            }
            set_player(new_track);
            fire_tracking_event('ended', track);
        });

        player.bind('change', function() {
            player.get(0).play();
        });

        player.bind('play', function() {
            fire_tracking_event('started', $(this).attr('track'));
        });

        player.bind('error', function() {
            var this_track = Number(player.attr('track'));
            fire_tracking_event('error', this_track);
            set_player(this_track + 1);
        });

        $("a.playlist_item").click(function(e) {
            // when the user clicks on a item in the playlist
            e.preventDefault();
            var this_track = $(this).attr('id').substr(6);
            set_player(Number(this_track) + 1);
        });

        function get_info(track) {
            // given a track number, return all the dta for that track.
            return {
                song: $('#info_' + track + ' .title').text(),
                slug: $('#info_' + track + ' .slug').text(),
                duration: slug = $('#info_' + track + ' .duration').text(),
                album: $('#album_title').text(),
            }
        }

        function fire_tracking_event(event, track) {
            var info = get_info(track);
            var full_title = info['song'] + ' - ' + info['album']
            //console.log(event, track);
            if(event == 'error') {
                _gaq.push(['_trackEvent', 'error', info['slug']]);
            } else {
                _gaq.push(['_trackEvent', event + '-by-slug', info['slug']]);
                _gaq.push(['_trackEvent', event + '-by-track', full_title]);
            }
        }

    </script>
{% endblock %}